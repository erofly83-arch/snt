<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>–§–∏–Ω–ê–Ω–∞–ª–∏–∑ ¬∑ –†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç</title>
<style>
:root{
  --bg:#0f1117;--s1:#1a1d2e;--s2:#222539;--s3:#2a2f4a;
  --brd:#2e3354;--acc:#6c63ff;--acc2:#00d4aa;
  --inc:#00c896;--exp:#ff5e6c;
  --tx:#e8eaf6;--tx2:#9ba3c7;--tx3:#6b72a0;
  --r:14px;--rs:8px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;}
header{background:var(--s1);border-bottom:1px solid var(--brd);padding:14px 24px;display:flex;align-items:center;gap:12px;}
.logo{width:38px;height:38px;background:linear-gradient(135deg,var(--acc),var(--acc2));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
header h1{font-size:1.15rem;font-weight:700;}
header h1 span{font-size:.78rem;color:var(--tx3);font-weight:400;}
.hdr-r{margin-left:auto;display:flex;gap:8px;align-items:center;}
.btn{padding:7px 16px;border:none;border-radius:50px;font-size:.81rem;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-a{background:var(--acc);color:#fff;}.btn-a:hover{background:#8b6bff;}
.btn-g{background:linear-gradient(135deg,var(--acc2),#00b899);color:#0f1117;}.btn-g:hover{box-shadow:0 4px 14px rgba(0,212,170,.3);}
.btn-gh{background:var(--s3);border:1px solid var(--brd);color:var(--tx2);}.btn-gh:hover{border-color:var(--acc);color:var(--tx);}
.btn-sm{padding:5px 11px;font-size:.75rem;}
.btn-d{background:rgba(255,94,108,.15);color:var(--exp);border:1px solid rgba(255,94,108,.3);}.btn-d:hover{background:rgba(255,94,108,.28);}
main{padding:20px 24px;max-width:1660px;margin:0 auto;}
.upzone{border:2px dashed var(--brd);border-radius:var(--r);padding:50px 36px;text-align:center;background:var(--s1);cursor:pointer;transition:all .3s;margin-bottom:20px;}
.upzone:hover,.upzone.dv{border-color:var(--acc);background:#1e2038;}
.upzone h2{font-size:1.15rem;margin-bottom:7px;}
.upzone p{color:var(--tx2);font-size:.84rem;}
#fileInput{display:none;}
.loading{display:none;text-align:center;padding:36px;}
.spin{width:44px;height:44px;border:4px solid var(--brd);border-top-color:var(--acc);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px;}
@keyframes spin{to{transform:rotate(360deg);}}
#dash{display:none;}
.cbar{display:flex;flex-wrap:wrap;gap:9px;align-items:center;background:var(--s1);padding:11px 16px;border-radius:var(--r);border:1px solid var(--brd);margin-bottom:16px;}
.cbar label{font-size:.8rem;color:var(--tx2);}
.cbar input[type=date]{background:var(--s2);border:1px solid var(--brd);border-radius:var(--rs);color:var(--tx);padding:5px 10px;font-size:.81rem;}
.cbar input[type=date]:focus{outline:none;border-color:var(--acc);}
#pInfo{font-size:.76rem;color:var(--tx3);}
.kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(195px,1fr));gap:12px;margin-bottom:16px;}
.kc{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);padding:16px 18px;position:relative;overflow:hidden;}
.kc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.ki::before{background:linear-gradient(90deg,#00c896,#00e5b0);}
.ke::before{background:linear-gradient(90deg,#ff5e6c,#ff8a5e);}
.kb::before{background:linear-gradient(90deg,var(--acc),var(--acc2));}
.kn::before{background:linear-gradient(90deg,#ffd700,#ffaa00);}
.kl{font-size:.7rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;}
.kv{font-size:1.55rem;font-weight:700;letter-spacing:-.5px;}
.ki .kv{color:var(--inc);}.ke .kv{color:var(--exp);}.kn .kv{color:#ffd700;}
.ks{font-size:.72rem;color:var(--tx3);margin-top:3px;}
.tabs{display:flex;gap:3px;background:var(--s1);padding:5px;border-radius:var(--r);border:1px solid var(--brd);width:fit-content;margin-bottom:16px;flex-wrap:wrap;}
.tab{padding:7px 16px;border-radius:9px;cursor:pointer;font-size:.84rem;font-weight:500;color:var(--tx2);border:none;background:none;transition:all .2s;}
.tab.active{background:var(--s3);color:var(--tx);}
.tab:hover:not(.active){color:var(--tx);}
.tc{display:none;}.tc.active{display:block;}
.sg{display:grid;grid-template-columns:260px 1fr;gap:14px;}
.cp{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;}
.cph{padding:11px 14px;border-bottom:1px solid var(--brd);font-size:.76rem;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.8px;}
.cl{overflow-y:auto;max-height:480px;}
.ci{display:flex;align-items:center;gap:8px;padding:9px 14px;border-bottom:1px solid #1e2238;cursor:pointer;transition:background .12s;}
.ci:hover,.ci.act{background:var(--s3);}
.cd{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.cn{font-size:.81rem;flex:1;}
.cb{font-size:.72rem;color:var(--tx3);background:var(--s3);padding:2px 6px;border-radius:20px;font-weight:600;}
.ca{font-size:.77rem;font-weight:700;text-align:right;min-width:65px;}
.tw{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;}
.tb{display:flex;align-items:center;gap:9px;padding:11px 14px;border-bottom:1px solid var(--brd);}
.sb{flex:1;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rs);color:var(--tx);padding:6px 11px;font-size:.82rem;}
.sb:focus{outline:none;border-color:var(--acc);}
.rc{font-size:.74rem;color:var(--tx3);white-space:nowrap;}
.ts{overflow-x:auto;max-height:480px;overflow-y:auto;}
table{width:100%;border-collapse:collapse;font-size:.79rem;}
thead th{background:var(--s2);color:var(--tx2);font-weight:600;padding:9px 11px;text-align:left;position:sticky;top:0;z-index:2;border-bottom:1px solid var(--brd);cursor:pointer;user-select:none;white-space:nowrap;}
thead th:hover{color:var(--tx);}
thead th.sorted{color:var(--acc);}
.sa{margin-left:2px;opacity:.4;font-size:.7rem;}
thead th.sorted .sa{opacity:1;}
tbody tr{border-bottom:1px solid #1a1d2e;transition:background .1s;}
tbody tr:hover{background:var(--s2);}
tbody td{padding:8px 11px;vertical-align:middle;}
.dd{color:var(--tx2);white-space:nowrap;font-size:.77rem;}
.da{font-weight:700;white-space:nowrap;}
.da.inc{color:var(--inc);}.da.exp{color:var(--exp);}
.dp{max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ddsc{max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--tx2);}
.spb{font-size:.64rem;background:rgba(108,99,255,.2);color:var(--acc);padding:1px 4px;border-radius:4px;margin-left:3px;}
.csel{background:var(--s2);border:1px solid var(--brd);border-radius:5px;color:var(--tx);padding:3px 5px;font-size:.72rem;cursor:pointer;max-width:130px;}
.csel:focus{outline:none;border-color:var(--acc);}
.spbtn{background:rgba(108,99,255,.15);border:1px solid rgba(108,99,255,.35);color:var(--acc);border-radius:5px;padding:2px 7px;font-size:.7rem;cursor:pointer;white-space:nowrap;}
.spbtn:hover{background:rgba(108,99,255,.28);}
.pgn{display:flex;align-items:center;gap:4px;padding:9px 14px;border-top:1px solid var(--brd);justify-content:center;flex-wrap:wrap;}
.pb{padding:4px 9px;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rs);color:var(--tx2);font-size:.77rem;cursor:pointer;transition:all .14s;}
.pb:hover:not(:disabled),.pb.act{background:var(--acc);border-color:var(--acc);color:#fff;}
.pb:disabled{opacity:.3;cursor:default;}
.pi{font-size:.77rem;color:var(--tx3);padding:0 4px;}
.og{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.oc{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);padding:18px;}
.oc h3{font-size:.88rem;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:7px;}
.sr{display:flex;align-items:center;gap:7px;margin-bottom:9px;}
.sbw{flex:1;height:4px;background:var(--s3);border-radius:3px;overflow:hidden;}
.sbb{height:100%;border-radius:3px;transition:width .5s;}
.sn{font-size:.79rem;min-width:140px;}
.sa2{font-size:.76rem;font-weight:700;min-width:78px;text-align:right;}
.sp{font-size:.7rem;color:var(--tx3);min-width:34px;text-align:right;}
.cg{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.cc{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);padding:16px;}
.cc h3{font-size:.74rem;color:var(--tx2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:11px;}
canvas{max-height:230px;}
.rules-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.rules-col h4{font-size:.82rem;font-weight:700;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--brd);}
.ri{background:var(--s2);border-radius:var(--rs);padding:9px 13px;margin-bottom:7px;}
.ri strong{font-size:.83rem;}
.ri p{font-size:.77rem;color:var(--tx2);margin-top:3px;line-height:1.45;}
.arp{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);padding:20px;margin-bottom:16px;}
.arp h3{font-size:.9rem;font-weight:700;margin-bottom:14px;}
.ar-form{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:end;margin-bottom:14px;}
.ar-form label{font-size:.76rem;color:var(--tx3);display:block;margin-bottom:4px;}
.ar-form input,.ar-form select{width:100%;background:var(--s2);border:1px solid var(--brd);border-radius:var(--rs);color:var(--tx);padding:7px 11px;font-size:.82rem;}
.ar-form input:focus,.ar-form select:focus{outline:none;border-color:var(--acc);}
.ar-table{width:100%;border-collapse:collapse;font-size:.8rem;margin-top:8px;}
.ar-table th{background:var(--s2);color:var(--tx2);font-weight:600;padding:8px 11px;text-align:left;border-bottom:1px solid var(--brd);}
.ar-table td{padding:8px 11px;border-bottom:1px solid #1e2238;vertical-align:middle;}
.ar-table tr:hover td{background:var(--s2);}
.conflict-badge{font-size:.7rem;background:rgba(255,94,108,.2);color:var(--exp);padding:2px 7px;border-radius:4px;margin-left:6px;}
.mov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.76);z-index:1000;align-items:center;justify-content:center;}
.mov.open{display:flex;}
.modal{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);padding:22px;max-width:580px;width:92%;max-height:85vh;overflow-y:auto;}
.modal h2{font-size:.98rem;margin-bottom:12px;}
.mc{float:right;background:none;border:none;color:var(--tx2);font-size:1.2rem;cursor:pointer;}
.split-row{display:flex;gap:8px;align-items:center;background:var(--s2);padding:9px 11px;border-radius:var(--rs);margin-bottom:7px;}
.split-row input[type=number]{background:var(--s3);border:1px solid var(--brd);border-radius:5px;color:var(--tx);padding:5px 8px;font-size:.82rem;width:115px;}
.split-row input[type=number]:focus{outline:none;border-color:var(--acc);}
.split-row select{background:var(--s3);border:1px solid var(--brd);border-radius:5px;color:var(--tx);padding:5px 8px;font-size:.82rem;flex:1;}
.sti{font-size:.79rem;color:var(--tx2);margin-bottom:11px;padding:7px 11px;background:var(--s2);border-radius:var(--rs);}
.sti.err .rest{color:var(--exp);}
.toast{position:fixed;bottom:22px;right:22px;background:var(--s3);border:1px solid var(--brd);border-radius:var(--rs);padding:10px 16px;font-size:.82rem;color:var(--tx);z-index:2000;display:none;box-shadow:0 4px 22px rgba(0,0,0,.4);}
.toast.show{display:block;animation:fi .3s;}
@keyframes fi{from{opacity:0;transform:translateY(5px);}to{opacity:1;}}
.nodata{text-align:center;padding:44px;color:var(--tx3);font-size:.86rem;}
@media(max-width:860px){main{padding:10px;}.sg{grid-template-columns:1fr;}.cg{grid-template-columns:1fr;}.og{grid-template-columns:1fr;}.ar-form{grid-template-columns:1fr;}.rules-grid{grid-template-columns:1fr;}}

/* ‚îÄ‚îÄ Period quick-pick ‚îÄ‚îÄ */
.pquick{display:flex;flex-wrap:wrap;gap:5px;align-items:center;}
.pqb{padding:4px 12px;border-radius:20px;font-size:.75rem;font-weight:600;cursor:pointer;border:1px solid var(--brd);background:var(--s2);color:var(--tx2);transition:all .18s;line-height:1.5;}
.pqb:hover{border-color:var(--acc);color:var(--tx);}
.pqb.act{background:var(--acc);border-color:var(--acc);color:#fff;}
.pdate-wrap{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.pdate-wrap input[type=date]{background:var(--s2);border:1px solid var(--brd);border-radius:var(--rs);color:var(--tx);padding:5px 10px;font-size:.81rem;cursor:pointer;}
.pdate-wrap input[type=date]:focus{outline:none;border-color:var(--acc);}
/* ‚îÄ‚îÄ Chart header ‚îÄ‚îÄ */
.chart-wrap{position:relative;}
.chart-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;gap:6px;}
.chart-hdr-left{display:flex;flex-direction:column;}
.chart-hdr h3{font-size:.74rem;color:var(--tx2);text-transform:uppercase;letter-spacing:.6px;margin:0;}
.chart-period{font-size:.67rem;color:var(--tx3);margin-top:2px;}
.btn-save-chart{background:none;border:1px solid var(--brd);border-radius:6px;color:var(--tx3);font-size:.71rem;padding:3px 9px;cursor:pointer;transition:all .15s;white-space:nowrap;flex-shrink:0;}
.btn-save-chart:hover{border-color:var(--acc);color:var(--tx);}
</style>
</head>
<body>
<header>
  <div class="logo">üìä</div>
  <div><h1>–§–∏–Ω–ê–Ω–∞–ª–∏–∑ <span>¬∑ –†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç</span></h1></div>
  <div class="hdr-r">
    <button class="btn btn-gh btn-sm" onclick="sw('rules')">üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
    <button class="btn btn-g btn-sm" id="expAll" style="display:none;" onclick="exportFull()">‚¨á –ü–æ–ª–Ω—ã–π XLSX</button>
  </div>
</header>
<main>
<div class="upzone" id="upz"
  ondragover="event.preventDefault();this.classList.add('dv')"
  ondragleave="this.classList.remove('dv')"
  ondrop="dropF(event)"
  onclick="document.getElementById('fileInput').click()">
  <div style="font-size:46px;margin-bottom:12px;">üìÇ</div>
  <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—ã–ø–∏—Å–∫—É —Ä–∞—Å—á—ë—Ç–Ω–æ–≥–æ —Å—á—ë—Ç–∞</h2>
  <p>–§–æ—Ä–º–∞—Ç –°–±–µ—Ä–±–∞–Ω–∫ .xlsx ¬∑ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ</p>
  <div class="btn btn-a" style="display:inline-block;margin-top:16px;">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</div>
  <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="loadF(this.files[0])"/>
</div>
<div class="loading" id="ld"><div class="spin"></div><p style="color:var(--tx2)">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º‚Ä¶</p></div>

<div id="dash">
  <div class="cbar" style="flex-direction:column;align-items:flex-start;gap:8px;">
    <div class="pquick" id="pquick">
      <span style="font-size:.8rem;color:var(--tx2);margin-right:2px;">–ü–µ—Ä–∏–æ–¥:</span>
      <button class="pqb" onclick="setPeriod('cm',this)">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</button>
      <button class="pqb" onclick="setPeriod('pm',this)">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</button>
      <button class="pqb" onclick="setPeriod('3m',this)">3 –º–µ—Å—è—Ü–∞</button>
      <button class="pqb" onclick="setPeriod('6m',this)">6 –º–µ—Å—è—Ü–µ–≤</button>
      <button class="pqb" onclick="setPeriod('cq',this)">–ö–≤–∞—Ä—Ç–∞–ª</button>
      <button class="pqb" onclick="setPeriod('cy',this)">–≠—Ç–æ—Ç –≥–æ–¥</button>
      <button class="pqb" onclick="setPeriod('py',this)">–ü—Ä–æ—à–ª—ã–π –≥–æ–¥</button>
      <button class="pqb" id="pqbAll" onclick="setPeriod('all',this)">–í—Å—ë –≤—Ä–µ–º—è</button>
    </div>
    <div class="pdate-wrap">
      <span style="font-size:.8rem;color:var(--tx2);">—Å</span>
      <input type="date" id="dFrom" onchange="clearPqActive();applyF()"/>
      <span style="font-size:.8rem;color:var(--tx2);">–ø–æ</span>
      <input type="date" id="dTo" onchange="clearPqActive();applyF()"/>
      <button class="btn btn-a btn-sm" onclick="applyF()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button class="btn btn-gh btn-sm" onclick="resetF()">–°–±—Ä–æ—Å–∏—Ç—å</button>
      <span id="pInfo" style="font-size:.76rem;color:var(--tx3);margin-left:2px;"></span>
    </div>
  </div>
  <div class="kpi">
    <div class="kc ki"><div class="kl">–ü—Ä–∏—Ö–æ–¥—ã</div><div class="kv" id="kI">‚Äî</div><div class="ks" id="kIn"></div></div>
    <div class="kc ke"><div class="kl">–†–∞—Å—Ö–æ–¥—ã</div><div class="kv" id="kE">‚Äî</div><div class="ks" id="kEn"></div></div>
    <div class="kc kb" style="border-top:none;"><div style="position:absolute;top:0;left:0;right:0;height:3px;" id="bBar"></div><div class="kl">–ë–∞–ª–∞–Ω—Å</div><div class="kv" id="kB">‚Äî</div><div class="ks" id="kBs"></div></div>
    <div class="kc kn"><div class="kl">–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π</div><div class="kv" id="kC">‚Äî</div><div class="ks" id="kSp"></div></div>
  </div>
  <div class="tabs">
    <button class="tab active" data-tab="overview" onclick="sw('overview')">üè† –û–±–∑–æ—Ä</button>
    <button class="tab" data-tab="income" onclick="sw('income')">üìà –ü—Ä–∏—Ö–æ–¥—ã</button>
    <button class="tab" data-tab="expense" onclick="sw('expense')">üìâ –†–∞—Å—Ö–æ–¥—ã</button>
    <button class="tab" data-tab="all" onclick="sw('all')">üìã –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</button>
    <button class="tab" data-tab="charts" onclick="sw('charts')">üìä –ì—Ä–∞—Ñ–∏–∫–∏</button>
    <button class="tab" data-tab="accrules" onclick="sw('accrules')">‚öôÔ∏è –ü—Ä–∞–≤–∏–ª–∞ —Å—á—ë—Ç–æ–≤/–ò–ù–ù</button>
    <button class="tab" data-tab="rules" onclick="sw('rules')">üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
  </div>

  <div class="tc active" id="tc-overview">
    <div class="og">
      <div class="oc"><h3><span style="width:8px;height:8px;border-radius:50%;background:var(--inc);display:inline-block;"></span>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏—Ö–æ–¥–æ–≤</h3><div id="ovI"></div></div>
      <div class="oc"><h3><span style="width:8px;height:8px;border-radius:50%;background:var(--exp);display:inline-block;"></span>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3><div id="ovE"></div></div>
    </div>
  </div>

  <div class="tc" id="tc-income">
    <div class="sg">
      <div class="cp"><div class="cph">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤</div><div class="cl" id="iCL"></div></div>
      <div class="tw">
        <div class="tb"><input class="sb" placeholder="üîç –ü–æ–∏—Å–∫‚Ä¶" id="srI" oninput="srch('income')"/><span class="rc" id="rcI"></span><button class="btn btn-g btn-sm" onclick="expX('income')">‚¨á XLSX</button></div>
        <div class="ts"><table><thead><tr>
          <th onclick="srt('income',0)">–î–∞—Ç–∞<span class="sa">‚Üï</span></th>
          <th onclick="srt('income',1)">–°—É–º–º–∞<span class="sa">‚Üï</span></th>
          <th onclick="srt('income',2)">–ö–∞—Ç–µ–≥–æ—Ä–∏—è<span class="sa">‚Üï</span></th>
          <th onclick="srt('income',3)">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç<span class="sa">‚Üï</span></th>
          <th>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</th><th>‚úÇÔ∏è</th>
        </tr></thead><tbody id="iBody"></tbody></table></div>
        <div class="pgn" id="iPgn"></div>
      </div>
    </div>
  </div>

  <div class="tc" id="tc-expense">
    <div class="sg">
      <div class="cp"><div class="cph">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</div><div class="cl" id="eCL"></div></div>
      <div class="tw">
        <div class="tb"><input class="sb" placeholder="üîç –ü–æ–∏—Å–∫‚Ä¶" id="srE" oninput="srch('expense')"/><span class="rc" id="rcE"></span><button class="btn btn-g btn-sm" onclick="expX('expense')">‚¨á XLSX</button></div>
        <div class="ts"><table><thead><tr>
          <th onclick="srt('expense',0)">–î–∞—Ç–∞<span class="sa">‚Üï</span></th>
          <th onclick="srt('expense',1)">–°—É–º–º–∞<span class="sa">‚Üï</span></th>
          <th onclick="srt('expense',2)">–ö–∞—Ç–µ–≥–æ—Ä–∏—è<span class="sa">‚Üï</span></th>
          <th onclick="srt('expense',3)">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç<span class="sa">‚Üï</span></th>
          <th>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</th><th></th>
        </tr></thead><tbody id="eBody"></tbody></table></div>
        <div class="pgn" id="ePgn"></div>
      </div>
    </div>
  </div>

  <div class="tc" id="tc-all">
    <div class="tw">
      <div class="tb"><input class="sb" placeholder="üîç –ü–æ–∏—Å–∫‚Ä¶" id="srA" oninput="srch('all')"/><span class="rc" id="rcA"></span><button class="btn btn-g btn-sm" onclick="expX('all')">‚¨á XLSX</button></div>
      <div class="ts"><table><thead><tr>
        <th onclick="srt('all',0)">–î–∞—Ç–∞<span class="sa">‚Üï</span></th>
        <th onclick="srt('all',1)">–¢–∏–ø<span class="sa">‚Üï</span></th>
        <th onclick="srt('all',2)">–°—É–º–º–∞<span class="sa">‚Üï</span></th>
        <th onclick="srt('all',3)">–ö–∞—Ç–µ–≥–æ—Ä–∏—è<span class="sa">‚Üï</span></th>
        <th onclick="srt('all',4)">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç<span class="sa">‚Üï</span></th>
        <th>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</th><th>‚úÇÔ∏è</th>
      </tr></thead><tbody id="aBody"></tbody></table></div>
      <div class="pgn" id="aPgn"></div>
    </div>
  </div>

  <div class="tc" id="tc-charts">
    <div class="cg">
      <div class="cc chart-wrap">
        <div class="chart-hdr">
          <div class="chart-hdr-left"><h3>üìÖ –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</h3><div class="chart-period" id="cpM"></div></div>
          <button class="btn-save-chart" onclick="saveChart('chM','dynamics')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <canvas id="chM"></canvas>
      </div>
      <div class="cc chart-wrap">
        <div class="chart-hdr">
          <div class="chart-hdr-left"><h3>üçï –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3><div class="chart-period" id="cpEP"></div></div>
          <button class="btn-save-chart" onclick="saveChart('chEP','expenses_pie')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <canvas id="chEP"></canvas>
      </div>
      <div class="cc chart-wrap">
        <div class="chart-hdr">
          <div class="chart-hdr-left"><h3>üçï –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏—Ö–æ–¥–æ–≤</h3><div class="chart-period" id="cpIP"></div></div>
          <button class="btn-save-chart" onclick="saveChart('chIP','income_pie')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <canvas id="chIP"></canvas>
      </div>
      <div class="cc chart-wrap">
        <div class="chart-hdr">
          <div class="chart-hdr-left"><h3>üìä –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤</h3><div class="chart-period" id="cpTE"></div></div>
          <button class="btn-save-chart" onclick="saveChart('chTE','top_expenses')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <canvas id="chTE"></canvas>
      </div>
    </div>
  </div>

  <div class="tc" id="tc-accrules">
    <div class="arp">
      <h3>üìà –ü—Ä–∞–≤–∏–ª–∞ —Å—á—ë—Ç–æ–≤ –∏ –ò–ù–ù ‚Äî <span style="color:var(--inc)">–ü—Ä–∏—Ö–æ–¥—ã</span></h3>
      <div class="ar-form">
        <div><label>–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞ –∏–ª–∏ –ò–ù–ù</label><input type="text" id="arValI" placeholder="40911‚Ä¶ –∏–ª–∏ –ò–ù–ù 10/12 —Ü–∏—Ñ—Ä"/></div>
        <div><label>–¢–∏–ø</label><select id="arTypeI"><option value="account">–°—á—ë—Ç (—Å–æ–¥–µ—Ä–∂–∏—Ç)</option><option value="inn">–ò–ù–ù</option></select></div>
        <div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="arCatI"></select></div>
        <button class="btn btn-a btn-sm" style="height:34px;align-self:end;" onclick="addAccRule('income')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div id="arConflictI" style="display:none;margin-bottom:10px;"></div>
      <table class="ar-table"><thead><tr><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th><th>–¢–∏–ø</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ö–æ–Ω—Ñ–ª–∏–∫—Ç</th><th></th></tr></thead><tbody id="arBodyI"></tbody></table>
      <div style="margin-top:10px;"><button class="btn btn-a btn-sm" onclick="applyAccRules()">‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button></div>
    </div>
    <div class="arp">
      <h3>üìâ –ü—Ä–∞–≤–∏–ª–∞ —Å—á—ë—Ç–æ–≤ –∏ –ò–ù–ù ‚Äî <span style="color:var(--exp)">–†–∞—Å—Ö–æ–¥—ã</span></h3>
      <div class="ar-form">
        <div><label>–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞ –∏–ª–∏ –ò–ù–ù</label><input type="text" id="arValE" placeholder="40703‚Ä¶ –∏–ª–∏ –ò–ù–ù 10/12 —Ü–∏—Ñ—Ä"/></div>
        <div><label>–¢–∏–ø</label><select id="arTypeE"><option value="account">–°—á—ë—Ç (—Å–æ–¥–µ—Ä–∂–∏—Ç)</option><option value="inn">–ò–ù–ù</option></select></div>
        <div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="arCatE"></select></div>
        <button class="btn btn-a btn-sm" style="height:34px;align-self:end;" onclick="addAccRule('expense')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div id="arConflictE" style="display:none;margin-bottom:10px;"></div>
      <table class="ar-table"><thead><tr><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th><th>–¢–∏–ø</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ö–æ–Ω—Ñ–ª–∏–∫—Ç</th><th></th></tr></thead><tbody id="arBodyE"></tbody></table>
      <div style="margin-top:10px;"><button class="btn btn-a btn-sm" onclick="applyAccRules()">‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button></div>
    </div>
  </div>

  <div class="tc" id="tc-rules">
    <div class="rules-grid">
      <div class="rules-col"><h4 style="color:var(--inc)">üìà –ü—Ä–∏—Ö–æ–¥—ã</h4><div id="rulesI"></div></div>
      <div class="rules-col"><h4 style="color:var(--exp)">üìâ –†–∞—Å—Ö–æ–¥—ã</h4><div id="rulesE"></div></div>
    </div>
  </div>
</div>
</main>

<!-- SPLIT MODAL -->
<div class="mov" id="splitM" onclick="if(event.target===this)closeSplit()">
  <div class="modal" style="max-width:600px;">
    <button class="mc" onclick="closeSplit()">‚úï</button>
    <h2>‚úÇÔ∏è –†–∞–∑–¥–µ–ª–∏—Ç—å –ø–ª–∞—Ç—ë–∂</h2>
    <p style="font-size:.8rem;color:var(--tx2);margin-bottom:12px;" id="spDesc"></p>
    <div class="sti" id="spInfo">
      –°—É–º–º–∞: <strong id="spTot"></strong> &nbsp;¬∑&nbsp; –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: <strong id="spAss"></strong> &nbsp;¬∑&nbsp; –û—Å—Ç–∞—Ç–æ–∫: <strong class="rest" id="spRest"></strong>
    </div>
    <div id="spRows"></div>
    <div style="display:flex;gap:7px;margin-top:11px;">
      <button class="btn btn-gh btn-sm" onclick="addSpRow()">+ –°—Ç—Ä–æ–∫–∞</button>
      <div style="flex:1"></div>
      <button class="btn btn-d btn-sm" onclick="closeSplit()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-a btn-sm" onclick="confirmSplit()">‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ö–ê–¢–ï–ì–û–†–ò–ò ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const INCAT=[
  {id:'electricity',name:'–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è',color:'#FFD700',
   kw:['—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥','—ç–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω','—ç–ª.—ç–Ω–µ—Ä–≥','—ç/—ç–Ω–µ—Ä–≥','—ç–ª/—ç–Ω','—ç–ª.—ç','—ç/—ç','–∑–∞ —ç–ª–µ–∫—Ç—Ä','–∑–∞ —Å–≤–µ—Ç','–∑–∞ —ç/','–∫–≤—Ç','–∫–≤.—á','–∫–∏–ª–æ–≤–∞—Ç—Ç','—ç–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±','—ç–ª–µ–∫—Ç.','—Å–≤–µ—Ç –ø—Ä–µ–¥','—Å–≤–µ—Ç —Ç–µ–∫','—ç.—ç','—ç–ª/','–∑–∞ –æ—Å–≤'],
   desc:'–û–ø–ª–∞—Ç–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏: —ç–ª.—ç–Ω–µ—Ä–≥–∏—è, –∫–í—Ç, –∑–∞ —Å–≤–µ—Ç, —ç/—ç–Ω–µ—Ä–≥–∏—è –∏ —Ç.–¥.'},
  {id:'membership',name:'–ß–ª–µ–Ω—Å–∫–∏–µ –≤–∑–Ω–æ—Å—ã',color:'#00C896',
   kw:['—á–ª–µ–Ω—Å–∫','—á–ª–µ–Ω –≤–∑–Ω','—á–ª.–≤–∑–Ω','—á–ª –≤–∑–Ω','—á–ª/–≤–∑–Ω','–≤–∑–Ω–æ—Å—ã –∑–∞ 20','–≤–∑–Ω–æ—Å 20','–≤–∑–Ω–æ—Å –∑–∞','—á–ª–µ–Ω—Å','—á–ª–µ–Ω—Å–∫–∏–π','–≤–∑–Ω–æ—Å—ã','–≤–∑–Ω–æ—Å'],
   exc:['—Ü–µ–ª–µ–≤','–≤—Å—Ç—É–ø','–ø–∞–µ–≤–æ–π','—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥','—ç–ª.—ç–Ω–µ—Ä–≥','—ç/—ç–Ω–µ—Ä–≥','–∫–≤—Ç'],
   desc:'–ß–ª–µ–Ω—Å–∫–∏–µ –≤–∑–Ω–æ—Å—ã –æ—Ç —Å–∞–¥–æ–≤–æ–¥–æ–≤.'},
  {id:'target',name:'–¶–µ–ª–µ–≤—ã–µ –≤–∑–Ω–æ—Å—ã',color:'#00D4AA',
   kw:['—Ü–µ–ª–µ–≤','–≤—Å—Ç—É–ø','–ø–∞–µ–≤–æ–π'],
   desc:'–¶–µ–ª–µ–≤—ã–µ –∏ –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∑–Ω–æ—Å—ã.'},
  {id:'water',name:'–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ',color:'#4FC3F7',
   kw:['–≤–æ–¥','–≤–æ–¥–æ—Å–Ω–∞–±','–∑–∞ –≤–æ–¥—É','–≤–æ–¥–æ–ø–æ—Ç—Ä–µ–±–ª','–º.–∫—É–±','–º¬≥'],
   exc:['—ç–ª–µ–∫—Ç—Ä','–≤–∑–Ω–æ—Å','–Ω–∞–ª–æ–≥'],
   desc:'–ü–ª–∞—Ç–µ–∂–∏ –∑–∞ –≤–æ–¥—É.'},
  {id:'other_income',name:'–ü—Ä–æ—á–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è',color:'#78909C',isDefault:true,
   desc:'–í—Å–µ –ø—Ä–æ—á–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è.'}
];

const EXCAT=[
  /* ‚îÄ‚îÄ –ó–∞—Ä–ø–ª–∞—Ç–∞: –≤–∫–ª—é—á–∞–µ—Ç –∞–≤–∞–Ω—Å ‚îÄ‚îÄ */
  {id:'salary',name:'–ó–∞—Ä–ø–ª–∞—Ç–∞ / –ü–æ–¥—Ä—è–¥',color:'#FF7043',
   kw:[
     '–∑–∞—Ä–ø–ª–∞—Ç','–∑–∞—Ä–∞–±–æ—Ç–Ω–∞—è –ø–ª–∞—Ç–∞','–∑–∞—Ä–∞–±–æ—Ç','–∑/–ø–ª–∞—Ç–∞',
     '–¥–æ–≥–æ–≤–æ—Ä –ø–æ–¥—Ä—è–¥–∞','–æ–ø–ª–∞—Ç–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É –ø–æ–¥—Ä—è–¥–∞','–≤—ã–ø–ª–∞—Ç–∞ –∑–∞—Ä–∞–±','–≤–æ–∑–Ω–∞–≥—Ä–∞–∂',
     '–∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –∑–∞—Ä–∞–±–æ—Ç–Ω–æ–π','–∑–∞–¥–æ–ª–∂. –ø–æ –∑–∞—Ä–ø','–∑–∞–¥–æ–ª–∂ –ø–æ –∑–∞—Ä–ø','–∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –∑–∞—Ä–ø',
     '–∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –∑/–ø','–ø–æ–≥–∞—à–µ–Ω–∏–µ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∑','–≤—ã–ø–ª–∞—Ç–∞ –∑/–ø','–∑/–ø –∑–∞',
     '–æ—Ç–ø—É—Å–∫–Ω','–≤—ã–ø–ª–∞—Ç–∞ –∑–∞ –æ—Ç–ø—É—Å–∫','–æ–ø–ª–∞—Ç–∞ –æ—Ç–ø—É—Å–∫–∞','–∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –æ—Ç–ø—É—Å–∫–Ω',
     '–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–ø—É—Å–∫','–æ—Ç–ø—É—Å–∫ –∑–∞','–∑–∞ –æ—Ç–ø—É—Å–∫',
     '–∞–≤–∞–Ω—Å','–≤—ã–ø–ª–∞—Ç–∞ –∞–≤–∞–Ω—Å–∞','–∞–≤–∞–Ω—Å –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É','–∞–≤–∞–Ω—Å –∑–∞','–∞–≤–∞–Ω—Å —Ä–∞–±–æ—Ç–Ω–∏–∫'
   ],
   exc:['–≤–∑—ã—Å–∫–∞–Ω','–∏—Å–ø–æ–ª–Ω–∏—Ç'],
   desc:'–ó–∞—Ä–ø–ª–∞—Ç–∞, –ø–æ–¥—Ä—è–¥, –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –∑/–ø, –æ—Ç–ø—É—Å–∫–Ω—ã–µ, –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–ø—É—Å–∫, –∞–≤–∞–Ω—Å.'},

  /* ‚îÄ‚îÄ –í–∑—ã—Å–∫–∞–Ω–∏—è ‚îÄ‚îÄ */
  {id:'levy',name:'–í–∑—ã—Å–∫–∞–Ω–∏—è / –ò—Å–ø–æ–ª–Ω. –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ',color:'#FF1744',
   kw:[
     '–≤–∑—ã—Å–∫–∞–Ω','–≤–∑—ã—Å–∫ ','–≤–∑—ã—Å–∫–∞ ','–ø–æ –≤–∑—ã—Å–∫–∞–Ω–∏—é',
     '–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω','–∏—Å–ø–æ–ª–Ω–∏—Ç. –ø—Ä–æ–∏–∑–≤–æ–¥','–ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–º—É –ª–∏—Å—Ç—É','–ø–æ –∏—Å–ø–æ–ª–Ω',
     '—Å—É–¥–µ–±–Ω –ø—Ä–∏–∫–∞–∑','–ø–æ —Ä–µ—à–µ–Ω–∏—é —Å—É–¥–∞','–ø–æ —Å—É–¥–µ–±–Ω–æ–º—É —Ä–µ—à–µ–Ω–∏—é',
     '–∞–ª–∏–º–µ–Ω—Ç','–ø—Ä–∏—Å—Ç–∞–≤—ã','—Ñ—Å—Å–ø','–∞—Ä–µ—Å—Ç —Å—á–µ—Ç','–∞—Ä–µ—Å—Ç –Ω–∞ —Å—á–µ—Ç',
     '–∏–Ω–∫–∞—Å—Å–æ–≤–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ','–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∑—ã—Å–∫–∞–Ω–∏–µ'
   ],
   exc:[],
   desc:'–í–∑—ã—Å–∫–∞–Ω–∏—è, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ª–∏—Å—Ç—ã, –§–°–°–ü, —Å—É–¥–µ–±–Ω—ã–µ –ø—Ä–∏–∫–∞–∑—ã, –∞—Ä–µ—Å—Ç—ã —Å—á—ë—Ç–∞, –∏–Ω–∫–∞—Å—Å–æ–≤—ã–µ –ø–æ—Ä—É—á–µ–Ω–∏—è.'},

  /* ‚îÄ‚îÄ –ù–∞–ª–æ–≥–∏ ‚îÄ‚îÄ */
  {id:'taxes',name:'–ù–∞–ª–æ–≥–∏ / –§–ù–°',color:'#EF5350',
   kw:['–Ω–∞–ª–æ–≥','–Ω–¥—Ñ–ª','–µ–¥–∏–Ω—ã–π –Ω–∞–ª–æ–≥','—Ñ–Ω—Å','–∏—Ñ–Ω—Å','–º–∏—Ñ–Ω—Å','–∫–∞–∑–Ω–∞—á–µ–π—Å—Ç–≤–æ','—Å—Ç.46 –Ω–∫','—É—Ñ–∫','—É—Å–Ω','—É–ø—Ä–æ—â—ë–Ω','–µ–Ω—Å'],
   exc:['—Å—Ç—Ä–∞—Ö–æ–≤','–≤–∑—ã—Å–∫–∞–Ω','–∏—Å–ø–æ–ª–Ω–∏—Ç'],
   desc:'–ù–∞–ª–æ–≥–∏, –§–ù–°, –ö–∞–∑–Ω–∞—á–µ–π—Å—Ç–≤–æ, –£–°–ù, –ù–î–§–õ, –ï–ù–°.'},

  {id:'insurance',name:'–°—Ç—Ä–∞—Ö–æ–≤—ã–µ –≤–∑–Ω–æ—Å—ã',color:'#EC407A',
   kw:['—Å—Ç—Ä–∞—Ö–æ–≤—ã–µ –≤–∑–Ω–æ—Å—ã','—Å—Ç—Ä–∞—Ö–æ–≤–æ–π –≤–∑–Ω–æ—Å','–Ω–µ—Å—á–∞—Å—Ç–Ω—ã—Ö —Å–ª—É—á–∞','–ø—Ä–æ—Ñ. –∑–∞–±–æ–ª–µ–≤','–æ—Å—Ñ—Ä','—Ñ—Å—Å','–æ–º—Å','–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω'],
   desc:'–û–°–§–†, –§–°–°, —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –æ—Ç –ù–°.'},

  {id:'bank',name:'–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏',color:'#26C6DA',
   kw:['–∫–æ–º–∏—Å—Å–∏—è','–≤–µ–¥–µ–Ω–∏–µ —Å—á–µ—Ç–∞','—Ä–∫–æ','–∫–æ–º–∏—Å','–∑–∞ –ø–µ—Ä–µ—á–∏—Å–ª','–¥–±–æ','–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —Å—á–µ—Ç'],
   desc:'–ö–æ–º–∏—Å—Å–∏–∏ –∑–∞ –†–ö–û, –ø–µ—Ä–µ–≤–æ–¥—ã, –≤–µ–¥–µ–Ω–∏–µ —Å—á—ë—Ç–∞.'},

  {id:'garbage',name:'–í—ã–≤–æ–∑ –¢–ö–û / –ú—É—Å–æ—Ä',color:'#8D6E63',
   kw:['—Ç–∫–æ','–≤—ã–≤–æ–∑ –æ—Ç—Ö–æ–¥–æ–≤','–º—É—Å–æ—Ä','—ç–∫–æ—Å–æ—é–∑','—Ç–±–æ','–æ–±—Ä–∞—â–µ–Ω–∏–µ —Å —Ç–∫–æ','–±—É–Ω–∫–µ—Ä','–º—É—Å–æ—Ä–æ—Å–±–æ—Ä–Ω–∏–∫','–≤—ç—Ä','—É—Ç–∏–ª–∏–∑–∞—Ü'],
   desc:'–¢–ö–û, –≤—ã–≤–æ–∑ –æ—Ç—Ö–æ–¥–æ–≤, –≠–∫–æ–°–æ—é–∑.'},

  {id:'electricity_buy',name:'–ó–∞–∫—É–ø–∫–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏',color:'#FFA726',
   kw:['—Å–±—ã—Ç','—ç–Ω–µ—Ä–≥–æ—Å–±—ã—Ç','–º—Ä—Å–∫','—Ä–æ—Å—Å–µ—Ç–∏','—Ç—ç–Ω','–ø–µ—Ä–µ–¥–∞—á–∞ —ç–ª–µ–∫—Ç—Ä'],
   exc:['–∫–æ–º–∏—Å—Å','–≤–∑–Ω–æ—Å','–Ω–∞–ª–æ–≥','–∑–∞—Ä–ø–ª–∞—Ç'],
   desc:'–û–ø–ª–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ (–æ–ø—Ç–æ–≤–∞—è –∑–∞–∫—É–ø–∫–∞).'},

  {id:'electricity_pay',name:'–û–ø–ª–∞—Ç–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏',color:'#FFB300',
   kw:['–æ–ø–ª–∞—Ç–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω','–æ–ø–ª–∞—Ç–∞ —ç/—ç','–æ–ø–ª–∞—Ç–∞ —ç–ª.—ç–Ω–µ—Ä–≥','–æ–ø–ª–∞—Ç–∞ –∑–∞ —ç–ª–µ–∫—Ç—Ä','–æ–ø–ª–∞—Ç–∞ –∑–∞ —Å–≤–µ—Ç',
       '—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥','—ç–ª.—ç–Ω–µ—Ä–≥','—ç/—ç–Ω–µ—Ä–≥','—ç–ª/—ç–Ω','–∑–∞ —ç–ª–µ–∫—Ç—Ä','–∑–∞ —Å–≤–µ—Ç','–∫–≤—Ç','–∫–≤.—á','–∫–∏–ª–æ–≤–∞—Ç—Ç'],
   exc:['—Å–±—ã—Ç','—ç–Ω–µ—Ä–≥–æ—Å–±—ã—Ç','–º—Ä—Å–∫','—Ä–æ—Å—Å–µ—Ç–∏','—Ç—ç–Ω','–ø–µ—Ä–µ–¥–∞—á–∞ —ç–ª–µ–∫—Ç—Ä','—á–ª–µ–Ω—Å–∫','–≤–∑–Ω–æ—Å','—á–ª–µ–Ω—Å–∫–∏–π','–∑–∞—Ä–ø–ª–∞—Ç','–∫–æ–º–∏—Å—Å','–Ω–∞–ª–æ–≥'],
   desc:'–û–ø–ª–∞—Ç–∞ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ (—Ä–∞—Å—Ö–æ–¥).'},

  {id:'accountable',name:'–ü–æ–¥–æ—Ç—á—ë—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞',color:'#66BB6A',
   kw:['–ø/–æ—Ç—á–µ—Ç','–ø–æ–¥–æ—Ç—á–µ—Ç','—Ö–æ–∑. –Ω—É–∂–¥—ã','—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω','–≤ –ø–æ–¥–æ—Ç—á–µ—Ç','—Ä–µ–µ—Å—Ç—Ä','–≤—ã–ø–ª–∞—Ç–∞ –ø–æ–¥ –æ—Ç—á–µ—Ç'],
   desc:'–ü/–æ—Ç—á—ë—Ç, —Ö–æ–∑. –Ω—É–∂–¥—ã.'},

  {id:'services',name:'–£—Å–ª—É–≥–∏ / –°–µ—Ä–≤–∏—Å—ã',color:'#7E57C2',
   kw:['—É—Å–ª—É–≥','—Å–µ—Ä–≤–∏—Å','–ø–æ –¥–æ–≥.','–¥–æ–≥.–æ—Ä–≥','–ø–æ —Å—á–µ—Ç—É','—Å–æ–±—Ä','–ø–æ –ø–æ—Ä.–∫–ª','–∏–Ω–∫–∞—Å—Å–æ'],
   exc:['—Ä–∫–æ','–≤–µ–¥–µ–Ω–∏–µ —Å—á–µ—Ç','–∫–æ–º–∏—Å—Å','–≤–∑—ã—Å–∫–∞–Ω'],
   desc:'–£—Å–ª—É–≥–∏ –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º, –∏–Ω–∫–∞—Å—Å–æ, IT.'},

  {id:'other_expense',name:'–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã',color:'#78909C',isDefault:true,
   desc:'–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã.'}
];

const AGGR_ACCOUNTS=['4.09078101000022e+19','4.091181010002002e+19','4.0907810600000004e+19','4.091181040018e+19'];
let ACC_RULES=[];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –£–¢–ò–õ–ò–¢–´ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fmt(n){if(n==null||isNaN(n))return'‚Äî';return new Intl.NumberFormat('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n)+' ‚ÇΩ';}
function fmtS(n){if(!n&&n!==0)return'‚Äî';const a=Math.abs(n);if(a>=1e6)return(n/1e6).toFixed(2)+'–ú ‚ÇΩ';if(a>=1e3)return(n/1e3).toFixed(1)+'–ö ‚ÇΩ';return fmt(n);}
function fmtD(d){if(!d)return'';return(d instanceof Date?d:new Date(d)).toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric'});}
function iso(d){if(!d)return'';return(d instanceof Date?d:new Date(d)).toISOString().split('T')[0];}
function toNum(v){
  if(v===null||v===undefined||v==='')return 0;
  if(typeof v==='number')return isNaN(v)?0:v;
  const s=String(v).trim().replace(/\s/g,'');
  if(!s)return 0;
  if(/^\d{1,3}(,\d{3})*(\.\d+)?$/.test(s))return parseFloat(s.replace(/,/g,''))||0;
  return parseFloat(s.replace(',','.'))||0;
}
function toast(m,dur=3000){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),dur);}
function getCat(id,isI){return(isI?INCAT:EXCAT).find(c=>c.id===id)||(isI?INCAT:EXCAT).at(-1);}
function catOpts(isI,selId){return(isI?INCAT:EXCAT).map(c=>`<option value="${c.id}"${c.id===selId?' selected':''}>${c.name}</option>`).join('');}
function extractInn(s){const m=(s||'').match(/\b(\d{10}|\d{12})\b/);return m?m[1]:null;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ö–ê–¢–ï–ì–û–†–ò–ó–ê–¶–ò–Ø ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function categorize(desc,cats){
  const d=(desc||'').toLowerCase();
  for(const c of cats){
    if(c.isDefault)continue;
    if(!c.kw||!c.kw.some(k=>d.includes(k)))continue;
    if(c.exc&&c.exc.some(e=>d.includes(e)))continue;
    return c.id;
  }
  return cats.find(c=>c.isDefault).id;
}

function applyAccRulesToRecord(rec){
  const rules=ACC_RULES.filter(r=>r.type===rec.type);
  if(!rules.length)return;
  for(const rule of rules){
    const v=(rule.val||'').trim();if(!v)continue;
    let match=false;
    if(rule.matchType==='account')match=(rec._rawAcct||'').includes(v);
    else if(rule.matchType==='inn')match=(rec._rawInn||'')===v;
    if(match){rec.catId=rule.catId;rec.manualCat=true;return;}
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ê–í–¢–û–°–ü–õ–ò–¢ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function tryAutoSplit(desc,total){
  const d=(desc||'').toLowerCase();
  const hasElec=['—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥','—ç–ª.—ç–Ω–µ—Ä–≥','—ç/—ç–Ω–µ—Ä–≥','—ç–ª/—ç–Ω','—ç–ª.—ç','—ç/—ç','–∑–∞ —ç–ª–µ–∫—Ç—Ä','–∑–∞ —Å–≤–µ—Ç','–∫–≤—Ç','–∫–∏–ª–æ–≤–∞—Ç—Ç','—ç–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±'].some(k=>d.includes(k));
  const hasMem=['—á–ª–µ–Ω—Å–∫','–≤–∑–Ω–æ—Å—ã','–≤–∑–Ω–æ—Å','—á–ª.–≤–∑–Ω','—á–ª–µ–Ω—Å–∫–∏–π','—á–ª–µ–Ω—Å'].some(k=>d.includes(k));
  const hasTgt=['—Ü–µ–ª–µ–≤','–≤—Å—Ç—É–ø'].some(k=>d.includes(k));
  if(!(hasElec&&(hasMem||hasTgt)))return null;
  const eA=extractAmt(d,['—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥','—ç–ª.—ç–Ω–µ—Ä–≥','—ç/—ç–Ω–µ—Ä–≥','—ç–ª/—ç–Ω','—ç–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂','–∑–∞ —ç–ª–µ–∫—Ç—Ä','—ç–ª.—ç','—ç/—ç']);
  const mA=extractAmt(d,['—á–ª–µ–Ω—Å–∫','—á–ª–µ–Ω—Å–∫–∏–π –≤–∑–Ω–æ—Å','—á–ª.–≤–∑–Ω','–≤–∑–Ω–æ—Å—ã','–≤–∑–Ω–æ—Å']);
  const tA=extractAmt(d,['—Ü–µ–ª–µ–≤']);
  const parts=[];let assigned=0;
  if(eA!==null&&eA>0&&eA<total){parts.push({catId:'electricity',amount:eA,note:'–∏–∑–≤–ª–µ—á–µ–Ω–æ'});assigned+=eA;}
  if(tA!==null&&tA>0&&tA<total){parts.push({catId:'target',amount:tA,note:'–∏–∑–≤–ª–µ—á–µ–Ω–æ'});assigned+=tA;}
  if(mA!==null&&mA>0&&mA<total){parts.push({catId:'membership',amount:mA,note:'–∏–∑–≤–ª–µ—á–µ–Ω–æ'});assigned+=mA;}
  if(parts.length>=2){
    const diff=Math.round((total-assigned)*100)/100;
    if(Math.abs(diff)>0.01){
      if(hasElec&&eA===null)parts.push({catId:'electricity',amount:diff,note:'–æ—Å—Ç–∞—Ç–æ–∫'});
      else if(hasMem&&mA===null)parts.push({catId:'membership',amount:diff,note:'–æ—Å—Ç–∞—Ç–æ–∫'});
      else parts[parts.length-1].amount=Math.round((parts[parts.length-1].amount+diff)*100)/100;
    }
    const tot2=parts.reduce((s,p)=>s+p.amount,0);
    if(Math.abs(tot2-total)<1.0)return parts;
  }
  return null;
}
function extractAmt(d,kws){
  for(const kw of kws){
    const idx=d.indexOf(kw);if(idx<0)continue;
    const after=d.slice(idx+kw.length,idx+kw.length+60);
    let m=after.match(/[\s:=,]*(\d[\d\s]*[.,]\d+|\d+)/);
    if(m){const n=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));if(!isNaN(n)&&n>0)return n;}
    const before=d.slice(Math.max(0,idx-30),idx);
    m=before.match(/(\d[\d\s]*[.,]\d+|\d+)\s*$/);
    if(m){const n=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));if(!isNaN(n)&&n>0)return n;}
  }
  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –î–ê–ù–ù–´–ï ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let RAW=[];
let FI=[],FE=[],FA=[];
const PS=50;
const PAGE={income:1,expense:1,all:1};
const TD={income:[],expense:[],all:[]};
const SS={income:{c:-1,a:true},expense:{c:-1,a:true},all:{c:-1,a:true}};
const AC={income:null,expense:null};
let charts={};
let splitTarget=null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ó–ê–ì–†–£–ó–ö–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function dropF(e){e.preventDefault();document.getElementById('upz').classList.remove('dv');const f=e.dataTransfer.files[0];if(f)loadF(f);}
function loadF(file){
  if(!file)return;
  document.getElementById('upz').style.display='none';
  document.getElementById('ld').style.display='block';
  const r=new FileReader();
  r.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'array',cellDates:true});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:null});
      parseRows(rows);
      document.getElementById('ld').style.display='none';
      document.getElementById('dash').style.display='block';
      document.getElementById('expAll').style.display='inline-block';
      initCatSelects();
      renderRules();
      renderAccTbl('income');
      renderAccTbl('expense');
      const sp=RAW.filter(r=>r.isSplit).length;
      toast(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${RAW.length} –∑–∞–ø–∏—Å–µ–π${sp?' ¬∑ '+sp+' –∞–≤—Ç–æ-—Ä–∞–∑–¥–µ–ª–µ–Ω–æ':''}`);
    }catch(err){
      document.getElementById('ld').style.display='none';
      document.getElementById('upz').style.display='block';
      alert('–û—à–∏–±–∫–∞: '+err.message);console.error(err);
    }
  };
  r.readAsArrayBuffer(file);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ü–ê–†–°–ò–ù–ì ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function parseRows(rows){
  RAW=[];let uid=0;
  for(let i=2;i<rows.length;i++){
    const row=rows[i];
    if(!row||!row.some(v=>v!==null&&v!==undefined&&v!==''))continue;
    let date=null;
    const dr=row[1];
    if(dr instanceof Date&&!isNaN(dr.getTime())){date=dr;}
    else if(typeof dr==='string'&&dr.trim()){
      const d2=new Date(dr.replace(/(\d{2})\.(\d{2})\.(\d{4})/,'$3-$2-$1').replace(' ','T'));
      if(!isNaN(d2.getTime()))date=d2;
    }else if(typeof dr==='number'&&dr>40000){date=new Date(Math.round((dr-25569)*86400*1000));}
    if(!date||isNaN(date.getTime()))continue;

    const dAmt=toNum(row[9]);
    const cAmt=toNum(row[13]);
    const dAcct=String(row[4]||'');
    const cAcct=String(row[8]||'');
    const desc=String(row[20]||row[19]||'').trim();
    const bankInfo=String(row[17]||'');

    function parseParty(s){
      const line=s.split(/[\n\r]/).map(x=>x.trim()).filter(Boolean);
      return line.length>=3?line[2]:line.length>=2?line[1]:line[0]||'';
    }

    if(cAmt>0&&dAmt===0){
      uid++;
      const rawAcct=dAcct;
      const inn=extractInn(rawAcct);
      const party=parseParty(rawAcct);
      const isAggr=AGGR_ACCOUNTS.some(a=>rawAcct.includes(a))||rawAcct.includes('40911')||rawAcct.includes('40907');
      const descL=desc.toLowerCase();
      const hasElec=['—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥','—ç–ª.—ç–Ω–µ—Ä–≥','—ç/—ç–Ω–µ—Ä–≥','—ç–ª/—ç–Ω','–∫–≤—Ç','–∫–≤.—á','–∫–∏–ª–æ–≤–∞—Ç—Ç','–∑–∞ —ç–ª–µ–∫—Ç—Ä','–∑–∞ —Å–≤–µ—Ç','—ç/—ç'].some(k=>descL.includes(k));
      const autoSp=tryAutoSplit(desc,cAmt);
      if(autoSp&&autoSp.length>=2){
        autoSp.forEach((s,si)=>{
          const rec={uid:uid*1000+si,origUid:uid,date,dateStr:iso(date),type:'income',
            amount:s.amount,catId:s.catId,desc,party,bank:bankInfo,
            isSplit:true,splitNote:s.note,splitIdx:si,splitTotal:autoSp.length,manualCat:false,
            _rawAcct:rawAcct,_rawInn:inn||''};
          applyAccRulesToRecord(rec);RAW.push(rec);
        });
      }else{
        let catId=isAggr&&!hasElec?'membership':categorize(desc,INCAT);
        const rec={uid,origUid:uid,date,dateStr:iso(date),type:'income',
          amount:cAmt,catId,desc,party,bank:bankInfo,
          isSplit:false,manualCat:false,_rawAcct:rawAcct,_rawInn:inn||''};
        applyAccRulesToRecord(rec);RAW.push(rec);
      }
    }else if(dAmt>0&&cAmt===0){
      uid++;
      const rawAcct=cAcct;
      const inn=extractInn(rawAcct);
      const party=parseParty(rawAcct);
      const catId=categorize(desc,EXCAT);
      const rec={uid,origUid:uid,date,dateStr:iso(date),type:'expense',
        amount:dAmt,catId,desc,party,bank:bankInfo,
        isSplit:false,manualCat:false,_rawAcct:rawAcct,_rawInn:inn||''};
      applyAccRulesToRecord(rec);RAW.push(rec);
    }
  }
  RAW.sort((a,b)=>b.date-a.date);
  initDates();applyF();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–¢ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initDates(){
  if(!RAW.length)return;
  const ds=RAW.map(r=>r.date.getTime());
  const minD=iso(new Date(Math.min(...ds)));
  const maxD=iso(new Date(Math.max(...ds)));
  const fromEl=document.getElementById('dFrom');
  const toEl=document.getElementById('dTo');
  fromEl.min=minD; fromEl.max=maxD;
  toEl.min=minD;   toEl.max=maxD;
  fromEl.value=minD;
  toEl.value=maxD;
  buildYearButtons(minD,maxD);
}

function buildYearButtons(minD,maxD){
  const minY=parseInt(minD.slice(0,4));
  const maxY=parseInt(maxD.slice(0,4));
  const wrap=document.getElementById('pquick');
  if(!wrap)return;
  wrap.querySelectorAll('.pqb-year').forEach(b=>b.remove());
  for(let y=maxY;y>=minY;y--){
    const btn=document.createElement('button');
    btn.className='pqb pqb-year';
    btn.textContent=y+'–≥.';
    const yr=y;
    btn.onclick=function(){setPeriod('year:'+yr,this);};
    const allBtn=document.getElementById('pqbAll');
    if(allBtn)allBtn.after(btn);else wrap.appendChild(btn);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –§–ò–õ–¨–¢–† ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function applyF(){
  const from=document.getElementById('dFrom').value;
  const to=document.getElementById('dTo').value;
  FA=RAW.filter(r=>{
    if(from&&r.dateStr<from)return false;
    if(to&&r.dateStr>to)return false;
    return true;
  });
  FI=FA.filter(r=>r.type==='income');
  FE=FA.filter(r=>r.type==='expense');
  AC.income=null;AC.expense=null;
  ['srI','srE','srA'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  recalc();
  if(FA.length){
    const ds=FA.map(r=>r.date.getTime());
    const mn=new Date(Math.min(...ds)),mx=new Date(Math.max(...ds));
    const el=document.getElementById('pInfo');
    if(el)el.textContent=`${fmtD(mn)} ‚Äî ${fmtD(mx)} ¬∑ ${FA.length} –æ–ø.`;
  }
}
function resetF(){initDates();clearPqActive();applyF();}

function recalc(){
  updateKPI();updateCatPanels();
  renderTbl('income',FI);renderTbl('expense',FE);renderTbl('all',FA);
  updateOv();
  if(document.querySelector('#tc-charts.active'))renderCharts();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ü–ï–†–ò–û–î ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function clearPqActive(){document.querySelectorAll('.pqb').forEach(b=>b.classList.remove('act'));}
function setPeriod(p,btn){
  clearPqActive();
  if(btn)btn.classList.add('act');
  if(!RAW.length)return;
  const ds=RAW.map(r=>r.date.getTime());
  const dataMin=iso(new Date(Math.min(...ds)));
  const dataMax=iso(new Date(Math.max(...ds)));
  const now=new Date();
  let f='',t='';
  if(p==='all'){f=dataMin;t=dataMax;}
  else if(p==='cm'){
    f=iso(new Date(now.getFullYear(),now.getMonth(),1));
    t=iso(new Date(now.getFullYear(),now.getMonth()+1,0));
  }else if(p==='pm'){
    f=iso(new Date(now.getFullYear(),now.getMonth()-1,1));
    t=iso(new Date(now.getFullYear(),now.getMonth(),0));
  }else if(p==='3m'){
    f=iso(new Date(now.getFullYear(),now.getMonth()-2,1));
    t=iso(new Date(now.getFullYear(),now.getMonth()+1,0));
  }else if(p==='6m'){
    f=iso(new Date(now.getFullYear(),now.getMonth()-5,1));
    t=iso(new Date(now.getFullYear(),now.getMonth()+1,0));
  }else if(p==='cq'){
    const q=Math.floor(now.getMonth()/3);
    f=iso(new Date(now.getFullYear(),q*3,1));
    t=iso(new Date(now.getFullYear(),q*3+3,0));
  }else if(p==='cy'){
    f=iso(new Date(now.getFullYear(),0,1));
    t=iso(new Date(now.getFullYear(),11,31));
  }else if(p==='py'){
    f=iso(new Date(now.getFullYear()-1,0,1));
    t=iso(new Date(now.getFullYear()-1,11,31));
  }else if(p.startsWith('year:')){
    const yr=parseInt(p.split(':')[1]);
    f=iso(new Date(yr,0,1));
    t=iso(new Date(yr,11,31));
  }
  // Clamp to data range
  if(f<dataMin)f=dataMin;
  if(t>dataMax)t=dataMax;
  const fromEl=document.getElementById('dFrom');
  const toEl=document.getElementById('dTo');
  fromEl.value=f;toEl.value=t;
  applyF();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KPI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateKPI(){
  const tI=FI.reduce((s,r)=>s+r.amount,0);
  const tE=FE.reduce((s,r)=>s+r.amount,0);
  const bal=tI-tE;
  const sp=RAW.filter(r=>r.isSplit).length;
  document.getElementById('kI').textContent=fmtS(tI);
  document.getElementById('kIn').textContent=FI.length+' –∑–∞–ø–∏—Å–µ–π';
  document.getElementById('kE').textContent=fmtS(tE);
  document.getElementById('kEn').textContent=FE.length+' –∑–∞–ø–∏—Å–µ–π';
  const bv=document.getElementById('kB');
  bv.textContent=fmtS(Math.abs(bal));
  bv.style.color=bal>=0?'var(--inc)':'var(--exp)';
  document.getElementById('kBs').textContent=bal>=0?'‚ñ≤ –ü—Ä–æ—Ñ–∏—Ü–∏—Ç':'‚ñº –î–µ—Ñ–∏—Ü–∏—Ç';
  document.getElementById('bBar').style.background=bal>=0?'linear-gradient(90deg,var(--inc),#00e5b0)':'linear-gradient(90deg,var(--exp),#ff8a5e)';
  document.getElementById('kC').textContent=FA.length;
  document.getElementById('kSp').textContent=sp?sp+' –ø–ª–∞—Ç–µ–∂–µ–π —Ä–∞–∑–¥–µ–ª–µ–Ω–æ':'';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAT PANELS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateCatPanels(){renderCP('income',FI,INCAT,'iCL');renderCP('expense',FE,EXCAT,'eCL');}
function renderCP(type,data,cats,elId){
  const tot={},cnt={};
  data.forEach(r=>{tot[r.catId]=(tot[r.catId]||0)+r.amount;cnt[r.catId]=(cnt[r.catId]||0)+1;});
  const cl=type==='income'?'var(--inc)':'var(--exp)';
  let h=`<div class="ci${AC[type]===null?' act':''}" onclick="catF('${type}',null)">
    <span class="cd" style="background:#6c63ff"></span><span class="cn">–í—Å–µ</span><span class="cb">${data.length}</span></div>`;
  cats.filter(c=>tot[c.id]).sort((a,b)=>(tot[b.id]||0)-(tot[a.id]||0)).forEach(c=>{
    h+=`<div class="ci${AC[type]===c.id?' act':''}" onclick="catF('${type}','${c.id}')">
      <span class="cd" style="background:${c.color}"></span>
      <span class="cn">${c.name}</span>
      <span class="cb">${cnt[c.id]||0}</span>
      <span class="ca" style="color:${cl}">${fmtS(tot[c.id]||0)}</span></div>`;
  });
  const el=document.getElementById(elId);if(el)el.innerHTML=h;
}
function catF(type,catId){
  AC[type]=catId;
  const src=type==='income'?FI:FE;
  renderTbl(type,catId?src.filter(r=>r.catId===catId):src);
  renderCP(type,type==='income'?FI:FE,type==='income'?INCAT:EXCAT,type==='income'?'iCL':'eCL');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateOv(){renderSC('ovI',FI,INCAT,'var(--inc)');renderSC('ovE',FE,EXCAT,'var(--exp)');}
function renderSC(id,data,cats,color){
  const tot={};data.forEach(r=>{tot[r.catId]=(tot[r.catId]||0)+r.amount;});
  const total=data.reduce((s,r)=>s+r.amount,0);
  const el=document.getElementById(id);if(!el)return;
  if(!total){el.innerHTML='<p class="nodata">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';return;}
  el.innerHTML=cats.filter(c=>tot[c.id]).sort((a,b)=>(tot[b.id]||0)-(tot[a.id]||0)).map(c=>{
    const amt=tot[c.id]||0,pct=(amt/total*100).toFixed(1);
    return`<div class="sr">
      <span class="sn">${c.name}</span>
      <div class="sbw"><div class="sbb" style="width:${pct}%;background:${c.color}"></div></div>
      <span class="sp">${pct}%</span>
      <span class="sa2" style="color:${color}">${fmtS(amt)}</span></div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –¢–ê–ë–õ–ò–¶–´ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderTbl(type,data){TD[type]=data;PAGE[type]=1;renderPg(type);}
function renderPg(type){
  const data=TD[type],pg=PAGE[type],start=(pg-1)*PS;
  const slice=data.slice(start,start+PS);
  const isAll=type==='all';
  const bodyId=isAll?'aBody':type==='income'?'iBody':'eBody';
  const rcId=isAll?'rcA':type==='income'?'rcI':'rcE';
  const pgnId=isAll?'aPgn':type==='income'?'iPgn':'ePgn';
  const el=document.getElementById(bodyId);if(!el)return;
  el.innerHTML=slice.map(r=>rowH(r,isAll)).join('');
  const rc=document.getElementById(rcId);
  if(rc)rc.textContent=`${Math.min(start+1,data.length)}‚Äì${Math.min(start+PS,data.length)} –∏–∑ ${data.length}`;
  renderPgn(pgnId,data.length,type);
}
function rowH(r,isAll){
  const cat=getCat(r.catId,r.type==='income');
  const cls=r.type==='income'?'inc':'exp';
  const pfx=r.type==='income'?'+':'‚àí';
  const sp=r.isSplit?`<span class="spb" title="–†–∞–∑–¥–µ–ª—ë–Ω: ${r.splitNote||''}">√∑</span>`:'';
  const party=(r.party||'').replace(/\n/g,' ').slice(0,42);
  const dsc=(r.desc||'').slice(0,95);
  const isI=r.type==='income';
  const uid=r.uid;
  const csel=`<select class="csel" onchange="chgCat(${uid},'${r.type}',this.value)">${catOpts(isI,r.catId)}</select>`;
  const spbtn=isI?`<button class="spbtn" onclick="openSplit(${uid})" title="–†–∞–∑–±–∏—Ç—å">‚úÇÔ∏è</button>`:'';
  if(isAll){
    return`<tr>
      <td class="dd">${fmtD(r.date)}</td>
      <td><span style="background:${isI?'rgba(0,200,150,.14)':'rgba(255,94,108,.14)'};color:${isI?'var(--inc)':'var(--exp)'};padding:2px 6px;border-radius:20px;font-size:.71rem;">${isI?'–ü—Ä–∏—Ö–æ–¥':'–†–∞—Å—Ö–æ–¥'}</span></td>
      <td class="da ${cls}">${pfx}${fmt(r.amount)}${sp}</td>
      <td>${csel}</td>
      <td class="dp" title="${r.party}">${party}</td>
      <td class="ddsc" title="${r.desc}">${dsc}</td>
      <td>${spbtn}</td></tr>`;
  }
  return`<tr>
    <td class="dd">${fmtD(r.date)}</td>
    <td class="da ${cls}">${pfx}${fmt(r.amount)}${sp}</td>
    <td>${csel}</td>
    <td class="dp" title="${r.party}">${party}</td>
    <td class="ddsc" title="${r.desc}">${dsc}</td>
    <td>${spbtn}</td></tr>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –°–ú–ï–ù–ê –ö–ê–¢–ï–ì–û–†–ò–ò ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function chgCat(uid,type,newCatId){
  const rec=RAW.find(r=>r.uid===uid);if(!rec)return;
  rec.catId=newCatId;rec.manualCat=true;
  const from=document.getElementById('dFrom').value;
  const to=document.getElementById('dTo').value;
  FA=RAW.filter(r=>{if(from&&r.dateStr<from)return false;if(to&&r.dateStr>to)return false;return true;});
  FI=FA.filter(r=>r.type==='income');FE=FA.filter(r=>r.type==='expense');
  updateKPI();updateCatPanels();updateOv();
  if(document.querySelector('#tc-charts.active'))renderCharts();
  ['income','expense','all'].forEach(t=>{
    const src=t==='income'?FI:t==='expense'?FE:FA;
    TD[t]=AC[t]?src.filter(r=>r.catId===AC[t]):src;
    renderPg(t);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –†–ê–ó–ë–ò–ï–ù–ò–ï ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openSplit(uid){
  const rec=RAW.find(r=>r.uid===uid);if(!rec)return;
  splitTarget=rec;
  const sdEl=document.getElementById('spDesc');
  const stEl=document.getElementById('spTot');
  const srEl=document.getElementById('spRows');
  if(!sdEl||!stEl||!srEl)return;
  sdEl.textContent=`${fmtD(rec.date)} ¬∑ ${fmt(rec.amount)} ¬∑ ${(rec.desc||'').slice(0,110)}`;
  stEl.textContent=fmt(rec.amount);
  srEl.innerHTML='';
  addSpRow();addSpRow();
  updSpInfo();
  document.getElementById('splitM').classList.add('open');
}
function closeSplit(){document.getElementById('splitM').classList.remove('open');splitTarget=null;}
function addSpRow(){
  const wrap=document.getElementById('spRows');if(!wrap)return;
  const d=document.createElement('div');d.className='split-row';
  d.innerHTML=`<input type="number" min="0" step="0.01" placeholder="–°—É–º–º–∞" oninput="updSpInfo()">
    <select>${catOpts(true,'other_income')}</select>
    <button class="btn btn-d btn-sm" onclick="this.closest('.split-row').remove();updSpInfo()">‚úï</button>`;
  wrap.appendChild(d);
}
function updSpInfo(){
  if(!splitTarget)return;
  let asgn=0;
  document.querySelectorAll('#spRows .split-row').forEach(r=>{asgn+=parseFloat(r.querySelector('input').value)||0;});
  asgn=Math.round(asgn*100)/100;
  const rest=Math.round((splitTarget.amount-asgn)*100)/100;
  const ass=document.getElementById('spAss');const rst=document.getElementById('spRest');const inf=document.getElementById('spInfo');
  if(ass)ass.textContent=fmt(asgn);if(rst)rst.textContent=fmt(rest);
  if(inf)inf.classList.toggle('err',Math.abs(rest)>0.5);
}
function confirmSplit(){
  if(!splitTarget)return;
  const rows=document.querySelectorAll('#spRows .split-row');
  const parts=[];let total=0;
  rows.forEach(r=>{
    const amt=parseFloat(r.querySelector('input').value)||0;
    const catId=r.querySelector('select').value;
    if(amt>0)parts.push({catId,amount:amt});total+=amt;
  });
  if(parts.length<2){toast('‚ùå –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —á–∞—Å—Ç–∏');return;}
  if(Math.abs(total-splitTarget.amount)>1.0){toast(`‚ùå –†–∞–∑–Ω–∏—Ü–∞: ${fmt(Math.abs(total-splitTarget.amount))}`);return;}
  const idx=RAW.findIndex(r=>r.uid===splitTarget.uid);
  const base={...splitTarget};RAW.splice(idx,1);
  parts.forEach((p,si)=>{
    RAW.splice(idx+si,0,{...base,uid:base.uid*1000+si+9000,
      amount:p.amount,catId:p.catId,isSplit:true,splitNote:'–≤—Ä—É—á–Ω—É—é',
      splitIdx:si,splitTotal:parts.length,manualCat:true});
  });
  closeSplit();applyF();toast(`‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–æ –Ω–∞ ${parts.length} —á–∞—Å—Ç–∏`);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ü–†–ê–í–ò–õ–ê –°–ß–Å–¢–û–í/–ò–ù–ù ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initCatSelects(){
  const si=document.getElementById('arCatI');const se=document.getElementById('arCatE');
  if(si)si.innerHTML=catOpts(true,'membership');
  if(se)se.innerHTML=catOpts(false,'other_expense');
}
function addAccRule(type){
  const valEl=document.getElementById(type==='income'?'arValI':'arValE');
  const typeEl=document.getElementById(type==='income'?'arTypeI':'arTypeE');
  const catEl=document.getElementById(type==='income'?'arCatI':'arCatE');
  const conflEl=document.getElementById(type==='income'?'arConflictI':'arConflictE');
  if(!valEl||!typeEl||!catEl)return;
  const val=valEl.value.trim();
  if(!val){toast('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—á—ë—Ç–∞ –∏–ª–∏ –ò–ù–ù');return;}
  const matchType=typeEl.value;const catId=catEl.value;
  if(ACC_RULES.some(r=>r.val===val&&r.type===type&&r.matchType===matchType)){toast('‚ö†Ô∏è –¢–∞–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ —É–∂–µ –µ—Å—Ç—å');return;}
  const cats=type==='income'?INCAT:EXCAT;
  const defId=cats.find(c=>c.isDefault).id;
  const conflicts=ACC_RULES.filter(r=>r.val===val&&r.type===type&&r.catId!==catId&&r.catId!==defId);
  ACC_RULES.push({val,matchType,catId,type});
  valEl.value='';
  renderAccTbl(type);
  if(conflicts.length){
    const msg=`‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç: ¬´${val}¬ª —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ ¬´${getCat(conflicts[0].catId,type==='income').name}¬ª`;
    if(conflEl){conflEl.innerHTML=`<div style="background:rgba(255,94,108,.12);border:1px solid rgba(255,94,108,.3);border-radius:7px;padding:8px 12px;font-size:.8rem;color:var(--exp);">${msg}</div>`;conflEl.style.display='block';}
    toast('‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∞–≤–∏–ª',4000);
  }else{if(conflEl)conflEl.style.display='none';toast('‚úÖ –ü—Ä–∞–≤–∏–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');}
}
function renderAccTbl(type){
  const bodyId=type==='income'?'arBodyI':'arBodyE';
  const el=document.getElementById(bodyId);if(!el)return;
  const rules=ACC_RULES.filter(r=>r.type===type);
  if(!rules.length){el.innerHTML=`<tr><td colspan="5" style="text-align:center;padding:14px;color:var(--tx3);font-size:.79rem;">–ù–µ—Ç –ø—Ä–∞–≤–∏–ª</td></tr>`;return;}
  const isI=type==='income';
  const countMap={};rules.forEach(r=>countMap[r.val]=(countMap[r.val]||0)+1);
  const defId=(isI?INCAT:EXCAT).find(c=>c.isDefault).id;
  el.innerHTML=rules.map((r,idx)=>{
    const cat=getCat(r.catId,isI);
    const hasConflict=countMap[r.val]>1&&r.catId!==defId;
    const tl=r.matchType==='inn'?'–ò–ù–ù':'–°—á—ë—Ç (—Å–æ–¥–µ—Ä–∂–∏—Ç)';
    return`<tr>
      <td style="font-family:monospace;font-size:.78rem;">${r.val}</td>
      <td style="font-size:.77rem;color:var(--tx2);">${tl}</td>
      <td style="color:${cat.color};font-size:.78rem;">${cat.name}</td>
      <td>${hasConflict?'<span class="conflict-badge">‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç</span>':''}</td>
      <td><button class="btn btn-d btn-sm" onclick="delAccRule('${type}',${idx})">‚úï</button></td></tr>`;
  }).join('');
}
function delAccRule(type,idx){
  const rules=ACC_RULES.filter(r=>r.type===type);
  const rule=rules[idx];const gi=ACC_RULES.indexOf(rule);
  if(gi>=0)ACC_RULES.splice(gi,1);
  renderAccTbl(type);toast('üóë –£–¥–∞–ª–µ–Ω–æ');
}
function applyAccRules(){
  RAW.forEach(rec=>{
    if(rec.manualCat)return;
    if(rec.type==='income'){
      const isAggr=AGGR_ACCOUNTS.some(a=>(rec._rawAcct||'').includes(a))||(rec._rawAcct||'').includes('40911')||(rec._rawAcct||'').includes('40907');
      const hasElec=['—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥','—ç–ª.—ç–Ω–µ—Ä–≥','—ç/—ç–Ω–µ—Ä–≥','–∫–≤—Ç','–∫–≤.—á','–∑–∞ —ç–ª–µ–∫—Ç—Ä','–∑–∞ —Å–≤–µ—Ç','—ç/—ç'].some(k=>(rec.desc||'').toLowerCase().includes(k));
      rec.catId=isAggr&&!hasElec?'membership':categorize(rec.desc,INCAT);
    }else{rec.catId=categorize(rec.desc,EXCAT);}
    applyAccRulesToRecord(rec);
  });
  applyF();toast('‚úÖ –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, –ø–µ—Ä–µ—Å—á—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ü–û–ò–°–ö / –°–û–†–¢–ò–†–û–í–ö–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function srch(type){
  const id=type==='income'?'srI':type==='expense'?'srE':'srA';
  const q=(document.getElementById(id).value||'').toLowerCase();
  const src=type==='income'?FI:type==='expense'?FE:FA;
  TD[type]=q?src.filter(r=>(r.desc||'').toLowerCase().includes(q)||(r.party||'').toLowerCase().includes(q)||getCat(r.catId,r.type==='income').name.toLowerCase().includes(q)):src;
  PAGE[type]=1;renderPg(type);
}
function srt(type,col){
  const st=SS[type];st.a=st.c===col?!st.a:true;st.c=col;
  const g=[r=>r.date,r=>r.amount,r=>r.catId,r=>r.party,r=>r.desc,r=>r.type];
  TD[type].sort((a,b)=>{const va=g[col](a),vb=g[col](b);const c=va<vb?-1:va>vb?1:0;return st.a?c:-c;});
  PAGE[type]=1;renderPg(type);
  const tId=type==='income'?'tc-income':type==='expense'?'tc-expense':'tc-all';
  document.querySelectorAll(`#${tId} thead th`).forEach((th,i)=>{
    th.classList.toggle('sorted',i===col);
    const sa=th.querySelector('.sa');if(sa)sa.textContent=i===col?(st.a?'‚Üë':'‚Üì'):'‚Üï';
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ü–ê–ì–ò–ù–ê–¶–ò–Ø ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderPgn(elId,total,type){
  const el=document.getElementById(elId);if(!el)return;
  const pages=Math.ceil(total/PS),cur=PAGE[type];
  if(pages<=1){el.innerHTML='';return;}
  const show=[...new Set([1,pages,cur,cur-1,cur+1].filter(p=>p>=1&&p<=pages))].sort((a,b)=>a-b);
  let h=`<button class="pb" onclick="gp('${type}',${cur-1})" ${cur<=1?'disabled':''}>‚Äπ</button>`;
  let pv=0;
  show.forEach(p=>{
    if(p-pv>1)h+=`<span class="pi">‚Ä¶</span>`;
    h+=`<button class="pb${p===cur?' act':''}" onclick="gp('${type}',${p})">${p}</button>`;
    pv=p;
  });
  h+=`<button class="pb" onclick="gp('${type}',${cur+1})" ${cur>=pages?'disabled':''}>‚Ä∫</button>`;
  el.innerHTML=h;
}
function gp(type,p){const mx=Math.ceil(TD[type].length/PS);if(p<1||p>mx)return;PAGE[type]=p;renderPg(type);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –í–ö–õ–ê–î–ö–ò ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function sw(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
  document.querySelectorAll('.tc').forEach(c=>c.classList.remove('active'));
  const tc=document.getElementById('tc-'+name);if(tc)tc.classList.add('active');
  if(name==='charts')renderCharts();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ì–†–ê–§–ò–ö–ò ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function dch(id){if(charts[id]){charts[id].destroy();delete charts[id];}}
function setChartPeriods(){
  if(!FA.length)return;
  const ds=FA.map(r=>r.date.getTime());
  const s=fmtD(new Date(Math.min(...ds))),e=fmtD(new Date(Math.max(...ds)));
  const txt=`${s} ‚Äî ${e}`;
  ['cpM','cpEP','cpIP','cpTE'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=txt;});
}
function renderCharts(){setChartPeriods();
  dch('chM');
  const months={};
  FA.forEach(r=>{
    const k=r.date.getFullYear()+'-'+(r.date.getMonth()+1).toString().padStart(2,'0');
    if(!months[k])months[k]={i:0,e:0};
    if(r.type==='income')months[k].i+=r.amount;else months[k].e+=r.amount;
  });
  const keys=Object.keys(months).sort();
  const MN=['','–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
  const lbl=keys.map(k=>{const[y,m]=k.split('-');return MN[+m]+' '+y.slice(2);});
  const mEl=document.getElementById('chM');
  if(mEl)charts.chM=new Chart(mEl.getContext('2d'),{type:'bar',data:{labels:lbl,datasets:[
    {label:'–ü—Ä–∏—Ö–æ–¥—ã',data:keys.map(k=>months[k].i),backgroundColor:'rgba(0,200,150,.7)',borderRadius:3},
    {label:'–†–∞—Å—Ö–æ–¥—ã',data:keys.map(k=>months[k].e),backgroundColor:'rgba(255,94,108,.7)',borderRadius:3}
  ]},options:{responsive:true,plugins:{legend:{labels:{color:'#9ba3c7',font:{size:11}}}},scales:{
    x:{ticks:{color:'#6b72a0',maxRotation:45,font:{size:10}},grid:{color:'#1e2238'}},
    y:{ticks:{color:'#6b72a0',font:{size:10},callback:v=>fmtS(v)},grid:{color:'#1e2238'}}}}});
  renderPie('chEP',FE,EXCAT);renderPie('chIP',FI,INCAT);
  dch('chTE');
  const tot={};FE.forEach(r=>{const n=getCat(r.catId,false).name;tot[n]=(tot[n]||0)+r.amount;});
  const sorted=Object.entries(tot).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const teEl=document.getElementById('chTE');
  if(teEl)charts.chTE=new Chart(teEl.getContext('2d'),{type:'bar',data:{labels:sorted.map(e=>e[0]),datasets:[{label:'–†–∞—Å—Ö–æ–¥—ã',data:sorted.map(e=>e[1]),backgroundColor:'rgba(255,94,108,.74)',borderRadius:3}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#6b72a0',font:{size:10},callback:v=>fmtS(v)},grid:{color:'#1e2238'}},y:{ticks:{color:'#9ba3c7',font:{size:10}},grid:{color:'#1e2238'}}}}});
}
function renderPie(id,data,cats){
  dch(id);
  const tot={};data.forEach(r=>{tot[r.catId]=(tot[r.catId]||0)+r.amount;});
  const sorted=cats.filter(c=>tot[c.id]).sort((a,b)=>(tot[b.id]||0)-(tot[a.id]||0));
  if(!sorted.length)return;
  const el=document.getElementById(id);if(!el)return;
  charts[id]=new Chart(el.getContext('2d'),{type:'doughnut',data:{
    labels:sorted.map(c=>c.name),
    datasets:[{data:sorted.map(c=>tot[c.id]),backgroundColor:sorted.map(c=>c.color),borderWidth:1,borderColor:'#1a1d2e'}]
  },options:{responsive:true,plugins:{legend:{position:'bottom',labels:{color:'#9ba3c7',font:{size:10},boxWidth:10,padding:8}}}}});
}
function saveChart(id,name){
  const el=document.getElementById(id);if(!el)return;
  const a=document.createElement('a');a.href=el.toDataURL('image/png');
  a.download=`chart_${name}_${new Date().toISOString().slice(0,10)}.png`;a.click();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ü–†–ê–í–ò–õ–ê (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderRules(){
  const ri=document.getElementById('rulesI');
  const re=document.getElementById('rulesE');
  if(ri)ri.innerHTML=INCAT.map(c=>`<div class="ri"><strong style="color:${c.color}">${c.name}</strong><p>${c.desc||''}</p></div>`).join('');
  if(re)re.innerHTML=EXCAT.map(c=>`<div class="ri"><strong style="color:${c.color}">${c.name}</strong><p>${c.desc||''}</p></div>`).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –≠–ö–°–ü–û–†–¢ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function expX(type){
  const data=type==='income'?FI:type==='expense'?FE:FA;
  if(!data.length){toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');return;}
  const rows=data.map(r=>({
    '–î–∞—Ç–∞':fmtD(r.date),'–¢–∏–ø':r.type==='income'?'–ü—Ä–∏—Ö–æ–¥':'–†–∞—Å—Ö–æ–¥',
    '–°—É–º–º–∞':r.amount,'–ö–∞—Ç–µ–≥–æ—Ä–∏—è':getCat(r.catId,r.type==='income').name,
    '–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç':r.party,'–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ':r.desc
  }));
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'–î–∞–Ω–Ω—ã–µ');
  XLSX.writeFile(wb,`export_${type}_${new Date().toISOString().slice(0,10)}.xlsx`);
}
function exportFull(){
  if(!RAW.length){toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');return;}
  const rows=RAW.map(r=>({
    '–î–∞—Ç–∞':fmtD(r.date),'–¢–∏–ø':r.type==='income'?'–ü—Ä–∏—Ö–æ–¥':'–†–∞—Å—Ö–æ–¥',
    '–°—É–º–º–∞':r.amount,'–ö–∞—Ç–µ–≥–æ—Ä–∏—è':getCat(r.catId,r.type==='income').name,
    '–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç':r.party,'–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ':r.desc,
    '–†–∞–∑–¥–µ–ª—ë–Ω':r.isSplit?'–î–∞':'–ù–µ—Ç'
  }));
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏');
  XLSX.writeFile(wb,`full_export_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
</body>
</html>
